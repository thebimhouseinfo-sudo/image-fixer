<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Photo Fixer</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.12.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/upscaler@0.12.1/dist/browser/umd/upscaler.min.js"></script>
    
    <style>
        :root { --primary: #6366f1; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; justify-content: center; min-height: 100vh; }
        .container { width: 90%; max-width: 400px; padding: 20px; text-align: center; }
        
        /* Card UI */
        .glass-card { background: var(--card); border-radius: 24px; padding: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); }
        .preview-window { width: 100%; aspect-ratio: 1; background: #000; border-radius: 16px; overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center; }
        #displayImg { max-width: 100%; max-height: 100%; object-fit: contain; }

        /* Real-time Animation */
        .loader-overlay {
            display: none; position: absolute; inset: 0; background: rgba(15, 23, 42, 0.9);
            flex-direction: column; align-items: center; justify-content: center; z-index: 10;
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #334155; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* View Control Buttons */
        .toggle-row { display: flex; background: #0f172a; padding: 4px; border-radius: 12px; margin-top: 15px; gap: 4px; }
        .tgl-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; color: #94a3b8; background: transparent; font-weight: 700; cursor: pointer; }
        .tgl-btn.active { background: var(--primary); color: white; }

        /* Centered Pill Button */
        .btn-main { background: var(--primary); color: white; padding: 16px 40px; border-radius: 50px; display: inline-block; cursor: pointer; font-weight: 600; margin-top: 30px; border: none; font-size: 16px; }
        #downloadBtn { display: none; color: #10b981; font-weight: 700; margin-top: 20px; text-decoration: none; border: 1px solid #10b981; padding: 10px 20px; border-radius: 12px; }
        #debug-log { font-size: 10px; color: #64748b; margin-top: 15px; font-family: monospace; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="margin-bottom: 25px;">AI Image Fixer</h2>
    
    <div class="glass-card">
        <div class="preview-window">
            <div class="loader-overlay" id="loader">
                <div class="spinner"></div>
                <p id="loaderText" style="margin-top:15px; font-size:14px; font-weight: 600;">AI ENHANCING...</p>
            </div>
            <img id="displayImg" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
        </div>

        <div class="toggle-row">
            <button class="tgl-btn active" id="btnBefore">BEFORE</button>
            <button class="tgl-btn" id="btnAfter" disabled>AFTER</button>
        </div>
    </div>

    <label class="btn-main" id="uploadLabel">
        Select Photo
        <input type="file" id="fileInput" hidden accept="image/*">
    </label>

    <div id="debug-log">Status: Initializing...</div>
    <a href="#" id="downloadBtn">Download Fixed Photo â†“</a>
</div>

<script>
    let upscaler;
    let originalBase64 = "";
    let enhancedBase64 = "";

    const log = (msg) => { document.getElementById('debug-log').innerText = "Status: " + msg; };

    // Initialize Engine with a fallback
    try {
        upscaler = new Upscaler({
            model: {
                path: 'https://cdn.jsdelivr.net/npm/@upscalerjs/default-model@latest/models/model.json',
                scale: 2
            }
        });
        log("Ready for Upload");
    } catch (e) {
        log("AI Error. Try refreshing.");
    }

    const fileInput = document.getElementById('fileInput');
    const displayImg = document.getElementById('displayImg');
    const loader = document.getElementById('loader');
    const btnBefore = document.getElementById('btnBefore');
    const btnAfter = document.getElementById('btnAfter');
    const downloadBtn = document.getElementById('downloadBtn');

    fileInput.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        log("Loading file...");
        const reader = new FileReader();
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                // Resize for Mobile Browser Safety (MAX 400px)
                const canvas = document.createElement('canvas');
                const MAX = 400; 
                let w = img.width, h = img.height;
                if (w > h) { if (w > MAX) { h *= MAX / w; w = MAX; } }
                else { if (h > MAX) { w *= MAX / h; h = MAX; } }
                canvas.width = w; canvas.height = h;
                canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                
                originalBase64 = canvas.toDataURL('image/jpeg', 0.8);
                displayImg.src = originalBase64;
                runEngine();
            };
        };
        reader.readAsDataURL(file);
    };

    async function runEngine() {
        loader.style.display = 'flex';
        log("AI Thinking...");
        btnAfter.disabled = true;

        try {
            // Using a simpler execution for stability
            enhancedBase64 = await upscaler.upscale(originalBase64);
            
            displayImg.src = enhancedBase64;
            btnAfter.disabled = false;
            btnAfter.classList.add('active');
            btnBefore.classList.remove('active');
            
            downloadBtn.style.display = 'inline-block';
            downloadBtn.href = enhancedBase64;
            downloadBtn.download = "ai_fixed.png";
            log("Finished!");
        } catch (err) {
            console.error(err);
            log("Engine failed. Image too large for device.");
        } finally {
            loader.style.display = 'none';
        }
    }

    btnBefore.onclick = () => {
        if(!originalBase64) return;
        displayImg.src = originalBase64;
        btnBefore.classList.add('active');
        btnAfter.classList.remove('active');
    };

    btnAfter.onclick = () => {
        if(!enhancedBase64) return;
        displayImg.src = enhancedBase64;
        btnAfter.classList.add('active');
        btnBefore.classList.remove('active');
    };
</script>

</body>
</html>
